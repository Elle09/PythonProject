def add_transaction(transactions):

    try:

        date_str = input("Enter date (YYY-MM-DD): ")
        date = datetime.strptime(date_str, "%Y-%m-%d").date()

        customer_id = int(input("Enter customer ID: "))

        amount = float(input("Enter transaction amount: "))

        tx_type = input("Enter transaction type (credit/debit/transfer: ").lower() # .lower() removes case sensitivity in check 
        if tx_type not in [
            "credit",
            "debit",
            "transfer" 
        ]:

            print(
                "Invalid transaction type. Must be either credit, debit, or transfer."
            )
            return

        description = input("Enter transaction description: ")

        if transactions:
            transaction_id = max(tx["transaction_id"] for tx in transactions) + 1
        else:
            transaction_id = 1

        if tx_type == "debit":
            amount = -amount

        new_tx = {
            "transaction_id": transaction_id,
            "date": date,
            "customer_id": customer_id,
            "amount": amount,
            "type": tx_type,
            "description": description,
        }

        transactions.append(new_tx) # WHY ARE YOU WHITE UGH
        print("Transaction added!")

    except ValueError as e:
        print(f"Input error: {e}")


def view_transactions(transactions):
    print(f"{'ID':<4} | {'Date':<12} | {'Customer':<8} | {'Amount':<10} | {'Type':<8} | Description") # fixed nested quotes??
    print("-" * 75)

    for tx in transactions: 
        date_str = tx["date"].strftime("%b %d, %Y")
        amount_str = f"{tx['amount']:.2f}"

        print(f"{tx['transaction_id']:<4} | {date_str:<12} | {tx['customer_id']:<8} | {amount_str:<10} | {tx['type']:<8} | {tx['description']}")



def update_transaction(transactions):

    if len(transactions) == 0:
        print("No transactions to update")
        return
    
    count = 1
    for tx in transactions:
        print(str(count) + ". " + str(tx["transaction_id"]) + " | " + str(tx["date"]) + " | " + str(tx["customer_id"]) + " | " + str(tx["amount"]) + " | " + str(tx["type"]) + " | " + tx["description"])
        count +=1

    choice = input("Enter the number of the transaction you want to update (or type 'cancel' to quit): ")
    if choice.lower() == "cancel":
        print("Updates cancelled")
        return
    
    index = int(choice) - 1
    if index < 0 or index >= len(transactions):
        print("Update cancelled")
        return
    
    tx = transactions[index]
    print("What do you want to update? (date, customer_id, amount, type, description)")
    
    field = input("Field: ").lower()
    if field not in ["date", "customer_id", "amount", "type", "description"]:
        print("Invalid field")
        return

    new_value = input("Enter new value: ")

    if field == "date":
        tx["date"] = datetime.strptime(new_value, "%Y-%m-%d").date()
    
    elif field == "customer_id":
        tx["customer_id"] = int(new_value)
    
    elif field == "amount":
        amount = float(new_value)
        if tx["type"] == "debit":
            amount = -abs(amount)
        else:
            amount = abs(amount)
        tx["amount"] = amount
    
    elif field == "type":
        if new_value not in ["credit", "debit", "transfer"]:
            print("Invalid transaction type")
            return
        tx["type"] = new_value
    
    else:
        tx["description"] = new_value

    print("Transaction updated successfully!")



def delete_transaction(transactions):
    if len(transactions) == 0:
        print("No transaction to delete")
        return
    
    count = 1
    for tx in transactions:
        print(str(count) + ". " + str(tx["transaction_id"]) + " | " + str(tx["date"]) + " | " + str(tx["customer_id"]) + " | " + str(tx["amount"]) + " | " + str(tx["type"]) + " | " + tx["description"])
        count += 1

    choice = input("Enter the number of the transaction you want to delete (or type 'cancel' to quit): ")
    if choice.lower() == "cancel":
        print("Delete cancelled")
        return
    
    try:
        index = int(choice) - 1
        if index < 0 or index >= len(transactions):
            print("Invalid input, deletion cancelled")
            return 
    except ValueError:
        print("Invalid input, deletion cancelled")
        return


    tx = transactions[index]
    print("Your selection:")
    print(str(tx["transaction_id"]) + " | " + str(tx["date"]) + " | " + str(tx["customer_id"]) + " | " + str(tx["amount"]) + " | " + str(tx["type"]) + " | " + tx["description"])
    
    confirm = input("Are you sure you want to delete this transaction? once deleted it can no longer be retrieved. (yes/no): ").lower()
    if confirm == "yes":
        del transactions[index]
        print("Transaction deleted")
    else:
        print("Deletion cancelled")



    
def save_transactions(filename="financial_transactions.csv"):
    with open(filename, "w", newline="") as file:
        fieldnames = ["transaction_id", "date", "customer_id", "amount", "type", "description"]
        writer = csv.DictWriter(file, fieldnames=fieldnames)
        writer.writeheader()

        for tx in transactions:
            writer.writerow({
                "transaction_id": tx["transaction_id"],
                "date": tx["date"].strftime("%Y-%m-%d"),
                "customer_id": tx["customer_id"],
                "amount": f"{abs(tx['amount']):.2f}",
                "type": tx["type"],
                "description": tx["description"]
            })



def analyze_finances(transactions):
    summary = {"credit": 0.0, "debit": 0.0, "transfer": 0.0}
    customer_debits = {}

    for tx in transactions:
        tx_type = tx["type"]
        amt = abs(tx["amount"])

        if tx_type in summary:
            summary[tx_type] += amt

        if tx_type == "debit":
            c_id = tx["customer_id"]
            customer_debits[c_id] = customer_debits.get(c_id, 0) + amt
    
    net_balance = summary["credit"] - summary["debit"]

    if customer_debits:
        top_customer = max(customer_debits, key=customer_debits.get)
        top_debit = customer_debits[top_customer]
    else:
        top_customer, top_debit = None, 0


    output_lines = [
        "Financial Summary:",
        f"Total Credits: ${summary['credit']:.2f}",
        f"Total Debits: ${summary['debit']:.2f}",
        f"Total Transfers: ${summary['transfer']:.2f}",
        f"Total Credits: ${summary['credit']:.2f}",
        f"Net Balance: ${net_balance:.2f}"
        "",
        "By Type",
        f" Credit: ${summary['credit']:.2f}",
        f" Debit: ${summary['debit']:.2f}",
        f" Transfer: ${summary['transfer']:.2f}",
        "",
        f"Customer with highest debit: {top_customer} (${top_debit:.2f})"
    ]


    print("\n".join(output_lines))

    with open("analysis.txt", "w") as f:
              f.write("\n".join(output_lines))


load_transactions(transactions)
analyze_finances(transactions)

# testing123
# load_transactions(transactions)
# update_transaction(transactions)
# save_transactions() 
